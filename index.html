<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rehab Timer - Medical Edition</title>
    <style>
        :root {
            --bg-color: #e0ecef;       /* æ¸…æ½”æ„Ÿã®ã‚ã‚‹æ°´è‰² */
            --text-main: #2c3e50;      /* æ¿ƒã„ãƒã‚¤ãƒ“ãƒ¼ */
            --accent-work: #d98880;    /* è½ã¡ç€ã„ãŸèµ¤ */
            --accent-rest: #7fb3d5;    /* è½ã¡ç€ã„ãŸé’ */
            --btn-bg: #fff;
        }

        body { 
            font-family: 'Segoe UI', Meiryo, sans-serif; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0;
            background: var(--bg-color); 
            color: var(--text-main); 
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
        }

        #status { font-size: 2rem; font-weight: 600; letter-spacing: 2px; }

        /* ã‚¿ã‚¤ãƒãƒ¼ï¼šã‚¹ãƒãƒ›ã§ã¯ç”»é¢å¹…ã«åˆã‚ã›ã€PCã§ã¯ãƒ‡ã‚«ã™ããªã„ã‚ˆã†ã«èª¿æ•´ */
        #timer { 
            font-size: 25vw; 
            font-weight: 300; 
            margin: 10px 0; 
            font-variant-numeric: tabular-nums; 
        }
        @media (min-width: 600px) {
            #timer { font-size: 10rem; }
        }

        #info { font-size: 1.5rem; opacity: 0.8; margin-bottom: 30px; }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        #progress-container { width: 70%; height: 12px; background: #cedade; border-radius: 10px; overflow: hidden; margin-bottom: 40px; }
        #progress-bar { width: 0%; height: 100%; background: #85c1e9; transition: width 1s linear; }

        .controls { display: flex; gap: 20px; }

        button { 
            padding: 12px 40px; 
            font-size: 1.2rem; 
            cursor: pointer; 
            border: 2px solid var(--text-main); 
            border-radius: 8px;
            background: var(--btn-bg);
            color: var(--text-main);
            min-width: 150px;
            transition: all 0.2s;
        }
        button:active { transform: scale(0.95); }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .paused #timer { color: #95a5a6; } /* ä¸€æ™‚åœæ­¢ä¸­ã®è‰² */

        /* å®Œäº†æ™‚ã®ç‰¹åˆ¥ãªã‚¹ã‚¿ã‚¤ãƒ« */
    .finished #status { 
        font-size: 3.5rem; 
        color: #27ae60; /* é”æˆæ„Ÿã®ã‚ã‚‹ã‚°ãƒªãƒ¼ãƒ³ */
        transition: all 0.5s ease;
    }
    .finished { background-color: #d5f5e3; transition: background 1s; } /* èƒŒæ™¯ã‚‚å„ªã—ããŠç¥ã„ */
    </style>
</head>
<body>

    <div id="status">æº–å‚™ä¸­</div>
    <div id="timer">02:00</div>
    <div id="info">ã‚»ãƒƒãƒˆ 1 / 10</div>
    
    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <div class="controls">
        <button onclick="startTimer()" id="startBtn">é–‹å§‹</button>
        <button onclick="togglePause()" id="pauseBtn" style="display: none;">ä¸€æ™‚åœæ­¢</button>
    </div>

    <script>
        // è¨­å®šå€¤
        const WORK_TIME = 120; // é‹å‹•æ™‚é–“ï¼ˆç§’ï¼‰
        const REST_TIME = 60;  // ä¼‘æ†©æ™‚é–“ï¼ˆç§’ï¼‰
        const TOTAL_SETS = 10; // åˆè¨ˆã‚»ãƒƒãƒˆæ•°

        // çŠ¶æ…‹ç®¡ç†ç”¨å¤‰æ•°
        let timeLeft = WORK_TIME;
        let currentSet = 1;
        let isWork = true;
        let timerId = null;
        let wakeLock = null; 
        let isPaused = false;
        let audioCtx;

        /**
         * éŸ³ã‚’é³´ã‚‰ã™é–¢æ•°
         */
        function beep(freq, duration = 0.4) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "sine";
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        /**
         * ç”»é¢è¡¨ç¤ºã®æ›´æ–°
         */
function updateDisplay() {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timer').textContent = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            // ã€ä¿®æ­£ã€‘ã‚‚ã—å®Œäº†çŠ¶æ…‹ï¼ˆfinishedã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹ï¼‰ãªã‚‰ã€ã“ã“ã‹ã‚‰ä¸‹ã®æ–‡å­—æ›´æ–°ã¯ã—ãªã„
            if (document.body.classList.contains('finished')) return;

            const statusEl = document.getElementById('status');
            if (isWork) {
                statusEl.textContent = "é‹å‹•ä¸­";
                statusEl.style.color = "var(--accent-work)";
            } else {
                statusEl.textContent = "ä¼‘æ†©ä¸­";
                statusEl.style.color = "var(--accent-rest)";
            }
            document.getElementById('info').textContent = `ã‚»ãƒƒãƒˆ ${currentSet} / ${TOTAL_SETS}`;
            
            const totalSecondsInPhase = isWork ? WORK_TIME : REST_TIME;
            const phaseProgress = (totalSecondsInPhase - timeLeft) / totalSecondsInPhase;
            const totalProgress = ((currentSet - 1) + phaseProgress) / TOTAL_SETS * 100;
            document.getElementById('progress-bar').style.width = `${totalProgress}%`;
        }

        /**
         * ã‚¿ã‚¤ãƒãƒ¼ã®é–‹å§‹
         */
        async function startTimer() {
            if (timerId) return;

            // ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼ˆWake Lock APIï¼‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.error(`${err.name}, ${err.message}`);
                }
            }

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'block';
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            timerId = setInterval(() => {
                if (isPaused) return;

                timeLeft--;
                
                // æ™‚é–“åˆ‡ã‚Œã®åˆ¤å®š
                if (timeLeft < 0) {
                    // 10ã‚»ãƒƒãƒˆç›®ã®é‹å‹•ãŒçµ‚ã‚ã£ãŸã‚‰å³çµ‚äº†
                    if (isWork && currentSet === TOTAL_SETS) {
                        clearInterval(timerId);
                        finishTimer();
                        return;
                    }

                    beep(isWork ? 523.25 : 659.25);
                    
                    if (isWork) {
                        isWork = false;
                        timeLeft = REST_TIME;
                    } else {
                        isWork = true;
                        currentSet++;
                        timeLeft = WORK_TIME;
                    }
                }
                updateDisplay();
            }, 1000);
        }

        /**
         * çµ‚äº†æ™‚ã®å‡¦ç†
         */
function finishTimer() {
            beep(880, 0.8); 
            
            if (wakeLock !== null) {
                wakeLock.release().then(() => wakeLock = null);
            }

            timeLeft = 0;
            
            // å®Œäº†ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆã“ã‚Œã‚’åˆå›³ã«updateDisplayãŒæ–‡å­—æ›´æ–°ã‚’æ­¢ã‚ã‚‹ï¼‰
            document.body.classList.add('finished');
            
            const statusEl = document.getElementById('status');
            statusEl.textContent = "ğŸ‰ 1ã‚»ãƒƒãƒˆå®Œäº†ï¼";
            // ã“ã“ã§å¼·åˆ¶çš„ã«è‰²ã‚’å¤‰ãˆã‚‹å¿…è¦ã¯ãªã„ã§ã™ãŒã€å¿µã®ãŸã‚
            statusEl.style.color = "#27ae60"; 
            
            document.getElementById('progress-bar').style.width = "100%";
            
            // ãƒœã‚¿ãƒ³ã®å…¥ã‚Œæ›¿ãˆ
            document.getElementById('pauseBtn').style.display = 'none';
            const btnContainer = document.querySelector('.controls');
            // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€åˆã«æˆ»ã‚‹
            btnContainer.innerHTML = '<button onclick="location.reload()" style="border-color:#27ae60; color:#27ae60;">ã‚‚ã†ä¸€åº¦è¡Œã†</button>';
            
            updateDisplay(); // æ™‚é–“ã‚’00:00ã«ã™ã‚‹ãŸã‚ã«å‘¼ã¶ï¼ˆæ–‡å­—ã¯ä¸Šæ›¸ãã•ã‚Œãªã„ï¼‰
        }
        /**
         * ä¸€æ™‚åœæ­¢ã®åˆ‡ã‚Šæ›¿ãˆ
         */
        function togglePause() {
            isPaused = !isPaused;
            const btn = document.getElementById('pauseBtn');
            if (isPaused) {
                btn.textContent = "å†é–‹";
                document.body.classList.add('paused');
            } else {
                btn.textContent = "ä¸€æ™‚åœæ­¢";
                document.body.classList.remove('paused');
            }
        }
    </script>
</body>
</html>